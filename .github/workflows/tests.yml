name: FastEngine Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # Ежедневно в 2:00 UTC

env:
  BUILD_TYPE: Debug
  BUILD_DIR: build_test
  OUTPUT_DIR: test_results

jobs:
  # Тесты на Ubuntu
  test-ubuntu:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        test-type: [unit, memory, security, performance, concurrency]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libgtest-dev \
          valgrind \
          gcovr \
          lcov \
          jq
    
    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          sudo apt-get install -y gcc g++
        elif [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt-get install -y clang clang++
        fi
    
    - name: Configure CMake
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DENABLE_COVERAGE=ON
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(nproc)
    
    - name: Run tests
      run: |
        cd ${{ env.BUILD_DIR }}
        ../scripts/run_tests.sh --${{ matrix.test-type }} --coverage --build-dir . --output-dir ../${{ env.OUTPUT_DIR }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-ubuntu-${{ matrix.compiler }}-${{ matrix.test-type }}
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 30
    
    - name: Upload coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-ubuntu-${{ matrix.compiler }}-${{ matrix.test-type }}
        path: ${{ env.BUILD_DIR }}/coverage/
        retention-days: 30

  # Тесты на macOS
  test-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        test-type: [unit, memory, security, performance]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        brew install cmake googletest valgrind gcovr lcov jq
    
    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          brew install gcc
        elif [ "${{ matrix.compiler }}" = "clang" ]; then
          # Clang уже установлен на macOS
          clang --version
        fi
    
    - name: Configure CMake
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DENABLE_COVERAGE=ON
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(sysctl -n hw.ncpu)
    
    - name: Run tests
      run: |
        cd ${{ env.BUILD_DIR }}
        ../scripts/run_tests.sh --${{ matrix.test-type }} --coverage --build-dir . --output-dir ../${{ env.OUTPUT_DIR }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-macos-${{ matrix.compiler }}-${{ matrix.test-type }}
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 30

  # Тесты на Windows
  test-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        compiler: [msvc, clang]
        test-type: [unit, memory, security, performance]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        # Установка Google Test
        git clone https://github.com/google/googletest.git
        cd googletest
        mkdir build
        cd build
        cmake ..
        cmake --build . --config Release
        cmake --install . --prefix C:/gtest
        cd ../..
    
    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "msvc" ]; then
          # MSVC уже установлен на Windows
          cl
        elif [ "${{ matrix.compiler }}" = "clang" ]; then
          # Установка Clang
          choco install llvm
          echo "C:\Program Files\LLVM\bin" >> $GITHUB_PATH
        fi
    
    - name: Configure CMake
      run: |
        mkdir ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DGTEST_ROOT=C:/gtest
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel
    
    - name: Run tests
      run: |
        cd ${{ env.BUILD_DIR }}
        ../scripts/run_tests.sh --${{ matrix.test-type }} --build-dir . --output-dir ../${{ env.OUTPUT_DIR }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-windows-${{ matrix.compiler }}-${{ matrix.test-type }}
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 30

  # Тесты с AddressSanitizer
  test-asan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libgtest-dev \
          valgrind \
          gcovr \
          lcov \
          jq
    
    - name: Configure CMake with AddressSanitizer
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DENABLE_ASAN=ON
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(nproc)
    
    - name: Run tests with AddressSanitizer
      run: |
        cd ${{ env.BUILD_DIR }}
        ../scripts/run_tests.sh --memory --asan --build-dir . --output-dir ../${{ env.OUTPUT_DIR }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-asan
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 30

  # Тесты с ThreadSanitizer
  test-tsan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libgtest-dev \
          valgrind \
          gcovr \
          lcov \
          jq
    
    - name: Configure CMake with ThreadSanitizer
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DENABLE_TSAN=ON
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(nproc)
    
    - name: Run tests with ThreadSanitizer
      run: |
        cd ${{ env.BUILD_DIR }}
        ../scripts/run_tests.sh --concurrency --tsan --build-dir . --output-dir ../${{ env.OUTPUT_DIR }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-tsan
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 30

  # Тесты с Valgrind
  test-valgrind:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libgtest-dev \
          valgrind \
          gcovr \
          lcov \
          jq
    
    - name: Configure CMake
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DENABLE_VALGRIND=ON
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(nproc)
    
    - name: Run tests with Valgrind
      run: |
        cd ${{ env.BUILD_DIR }}
        ../scripts/run_tests.sh --memory --valgrind --build-dir . --output-dir ../${{ env.OUTPUT_DIR }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-valgrind
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 30

  # Сводный отчет
  test-summary:
    runs-on: ubuntu-latest
    needs: [test-ubuntu, test-macos, test-windows, test-asan, test-tsan, test-valgrind]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Generate summary report
      run: |
        mkdir -p summary
        echo "# FastEngine Test Summary" > summary/README.md
        echo "" >> summary/README.md
        echo "## Test Results" >> summary/README.md
        echo "" >> summary/README.md
        
        # Подсчет успешных тестов
        success_count=0
        total_count=0
        
        for artifact in artifacts/*/; do
          if [ -d "$artifact" ]; then
            total_count=$((total_count + 1))
            if [ -f "$artifact/test_report.html" ]; then
              success_count=$((success_count + 1))
            fi
          fi
        done
        
        echo "Total test runs: $total_count" >> summary/README.md
        echo "Successful test runs: $success_count" >> summary/README.md
        echo "Failed test runs: $((total_count - success_count))" >> summary/README.md
        echo "" >> summary/README.md
        
        # Список артефактов
        echo "## Artifacts" >> summary/README.md
        echo "" >> summary/README.md
        for artifact in artifacts/*/; do
          if [ -d "$artifact" ]; then
            artifact_name=$(basename "$artifact")
            echo "- $artifact_name" >> summary/README.md
          fi
        done
    
    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: summary/
        retention-days: 30

  # Уведомления
  notify:
    runs-on: ubuntu-latest
    needs: [test-ubuntu, test-macos, test-windows, test-asan, test-tsan, test-valgrind]
    if: always()
    
    steps:
    - name: Notify on failure
      if: failure()
      run: |
        echo "Tests failed! Check the logs for details."
        # Здесь можно добавить отправку уведомлений в Slack, Discord, email и т.д.
    
    - name: Notify on success
      if: success()
      run: |
        echo "All tests passed successfully!"
        # Здесь можно добавить отправку уведомлений в Slack, Discord, email и т.д.


